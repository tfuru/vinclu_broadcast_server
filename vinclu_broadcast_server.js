/** vinclu_broadcast_server.js** 機能* 受け取ったjson を接続している全てのクライアントへブロードキャストするWebSocketサーバーです* * 参考サイト* https://www.npmjs.org/package/websocket.io* http://mawatari.jp/archives/make-a-chat-application-in-node-js-and-websocket-io* **/// port番ポートでクライアントの接続を待ち受けるvar WebSocketServer = require('ws').Server;var http = require('http');var express = require('express');var app = express();var port = process.env.PORT || 8899; console.log({port:port});app.use(express.static(__dirname + '/'));var server = http.createServer(app);server.listen(port);var wsServer = new WebSocketServer({server: server});//ソケット一覧var connects = [];// クライアントからの接続イベントを処理wsServer.on('connection', function(ws) {    console.log('websocket connection open');	//配列にソケットを保存	connects.push(ws);	ws.on('message', function (data) {        broadcast(data);    });        ws.on('close', function() {        console.log('websocket connection close');    });});var broadcast = function(data){     // 実行時間を追加    var json = JSON.parse(data);    //接続クライアント数を返す    json.vinclu_cnt = connects.length;    data = JSON.stringify(json);    	connects.forEach(function (socket, i) {		if(socket.readyState===1){        	socket.send(data);        }        else{        	delete connects[i];        }    });};